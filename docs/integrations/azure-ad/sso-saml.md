# Azure Active Directory SSO (SAML)
------------

:::tip TL;DR 
To have ngrok enforce Single Sign-On using SAML with Azure Active Directory (Azure AD):
1. [Create an ngrok Edge](#create-edge)
2. [Create an Azure AD application](#create-aad-app)
3. [Update the ngrok configuration with the IdP metadata](#update-ngrok-config)
4. [Test your integration](#test-integration)
5. [Bonus: configure ngrok to enforce authorization based on Azure groups](#bonus)
:::

This article details how to configure Azure AD as an Identity Provider for your ngrok Edge.  By integrating Azure AD with ngrok, you can: 

- Restrict access to ngrok tunnels to only users who authenticated via Azure AD
- Configure Azure AD and ngrok to enforce user and group authorization
- Use Azure AD's dashboard to facilitate access to ngrok applications

## Requirements

To configure ngrok tunnels with Azure AD, you must have: 

- an ngrok enterprise account with an access token or admin access to configure edges with SAML
- a Microsoft Azure account with access to an Azure AD tenant

## Step 1: Create an ngrok Edge {#create-edge}

1. Go to the [ngrok dashboard](https://dashboard.ngrok.com) https://dashboard.ngrok.com
1. Click __Cloud Edge__ > __Edges__
1. Create an Edge:
    1. Click __New Edge__
    1. Click __HTTPS Edge__
    1. Click the __Pencil Icon__ next to "no description". Enter _Edge With Azure Active Directory SSO_ as the Edge name and click __Save__

1. Configure the SAML module for this Edge:
    1. On the Routes section, click __SAML__
    1. Click __Begin setup__
    1. In the Identity Provider section, copy the following XML as a placeholder into the input box
      
      ```xml
      <?xml version="1.0" encoding="utf-8"?>
      <EntityDescriptor xmlns="urn:oasis:names:tc:SAML:2.0:metadata"></EntityDescriptor>
      ```

        ![img/1-3.png](img/1-3.png)
    
    1. In the Service Provider section, copy the Entity ID and the ACS URL values generated by ngrok

    1. Click __Save__

## Step 2: Create an Azure AD application {#create-aad-app}

1. Go to your [Azure AD tenant in Azure](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Overview)

1. Create an enterprise application 
    1. Starting from the sidebar, in the Manage section, click __Enterprise Applications__ > __New application__
    1. Give your application a name (eg `www` for a website client).  Click __Create__

        ![img/2-2.png](img/2-2.png)

1. To assign users/groups for this application, in the Getting Started section, click __1. Assign users and groups__ > __Add user/group__ 

1. Set up single sign on with SAML
    1. In the Getting Started section, click on the box titled __2. Set up single sign on__ >  __SAML__
    1. Configure SAML.  In the Basic SAML Configuration box click __Edit__
        
        ![img/2-4.png](img/2-4.png)

    1. Add Identifier (Entity ID) and Reply URL (Assertion Consumer Service URL) values using the previously the ngrok generated Entity ID and ACS URL 

        ![img/2-4b.png](img/2-4b.png)

    1. Click __Save__
    1. Download the Metadata XML.  In the SAML Certificates box > Token signing certificate section > click __Download__ for the Federation Metadata XML

        ![img/2-4c.png](img/2-4c.png)

## Step 3: Update ngrok with the metadata {#update-ngrok-config}

1. Back in the ngrok dashboard for your Edge's SAML configuration, upload the XML file generated by Azure AD 

    ![img/3-1.png](img/3-1.png)

1. Click __Save__

## Step 4: Test the integration {#test-integration}

:::tip Note 
For this step, we assume you have an app running locally (i.e. on localhost:3000) with the ngrok client installed.
:::

1. Launch a tunnel connected to your configured Edge

1. On your Edge's page, in the Routes section, click __Start a tunnel__

    ![img/4-1.png](img/4-1.png)

1. Copy the tunnel command

    ![img/4-1b.png](img/4-1b.png)

1. Launch a terminal and paste the command, replacing `http://localhost:80` with your local web app address (e.g., `http://localhost:3000`)
1. Hit __Enter__ to launch the tunnel

1. Confirm that the tunnel is connected to your edge
    1. Return to the ngrok dashboard
    1. Close the __Start a tunnel__ and the __Tunnel group__ drawers
    1. Refresh the Edge page
    1. In the Routes section > Traffic section you will see the message _You have 1 tunnel online. Start additional tunnels to begin load balancing._

        ![img/4-2.png](img/4-2.png)

1. Copy the ngrok url on the Endpoints section

1. Access your Edge application
    1. In your browser, launch an incognito window
    1. Access your ngrok tunnel via your copied URL
    1. You should be prompted to log in with your Microsoft credentials
    1. After login, you should be able to see the application

## Bonus: Configure ngrok to enforce authorization based on Azure groups {#bonus}

1. In Azure, configure the SAML response to include group claims.  In the Attributes & Claims box click __Edit__

    ![img/5-1.png](img/5-1.png)

1. Click __Add a group claim__ > __Advanced options__ > Customize the name of the group claim
1. Set the name of the group claim to `groups`. This specific value is required for ngrok

    ![img/5-3.png](img/5-3.png)

1. Click __Save__ 
1. Go to your group page and copy the object Id (Azure AD returns group object Ids in the group claim)

    ![img/5-5.png](img/5-5.png)

1. Configure ngrok to enforce group authorization.  In ngrok on your Edge's page, in the Authorization section, update the groups input with your Azure group object Id (NOT group name) values

    ![img/5-6.png](img/5-6.png)

1. Access your Edge application
    1. In your browser, launch an incognito window
    1. Access your ngrok tunnel via your copied URL
    1. You should be prompted to log in with your Microsoft credentials
    1. Only users assigned to the authorized groups will have access to the application
    
