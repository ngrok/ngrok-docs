name: Auto-generate Docs PR

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: '30 10 * * *'  # 10:30 AM UTC daily (30 min after buildkite cron)
  workflow_dispatch:

jobs:
  check-and-create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Generate bot token
        uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.NGROK_DOCS_BOT_APP_ID }}
          private-key: ${{ secrets.NGROK_DOCS_BOT_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          ref: main
          persist-credentials: false

      - name: Fetch dev-gen-changes branch
        run: |
          git fetch origin ngrokrock/dev-gen-changes:ngrokrock/dev-gen-changes

      - name: Check for changes
        id: check
        run: |
          # Check if there are differences between main and dev-gen-changes
          if git diff --quiet main...ngrokrock/dev-gen-changes; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected between main and ngrokrock/dev-gen-changes"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected - will create/update PR"
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        id: cpr
        with:
          token: ${{ steps.generate-token.outputs.token }}
          title: "Docs: Auto-generated documentation update"
          body: |
            ## Auto-generated Documentation Update
            
            This PR contains automatically generated documentation changes from the ngrok monorepo.
            
            **Source:** `ngrokrock/dev-gen-changes` branch
            **Generated by:** Buildkite nightly job
          branch: ngrokrock/dev-gen-changes
          base: main

      - name: PR Info
        if: steps.check.outputs.has_changes == 'true' && steps.cpr.outputs.pull-request-number
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
