name: Check if a deleted file needs a redirect

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-redirects:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get deleted .mdx files
        id: deleted-files
        run: |
          git fetch origin ${{ github.base_ref }}
          deleted_files=$(git diff --name-only --diff-filter=D origin/${{ github.base_ref }}...HEAD | grep '\.mdx$' | grep -v '^snippets/' || true)
          echo "deleted_files<<EOF" >> $GITHUB_OUTPUT
          echo "$deleted_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for redirects
        run: |
          deleted_files="${{ steps.deleted-files.outputs.deleted_files }}"
          
          if [ -z "$deleted_files" ]; then
            echo "No .mdx files were deleted in this PR."
            exit 0
          fi
          
          echo "Checking redirects for deleted .mdx files..."
          missing_redirects=()
          
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            # Convert file path to expected redirect source
            # Remove .mdx extension and add leading /
            path_without_ext="${file%.mdx}"
            
            # If the file is index.mdx, remove /index from the path
            if [[ "$path_without_ext" == */index ]]; then
              redirect_source="/${path_without_ext%/index}"
            else
              redirect_source="/$path_without_ext"
            fi
            
            echo "Checking for redirect from: $redirect_source"
            
            # Check if redirect exists in docs.json
            if ! jq -e --arg source "$redirect_source" '.redirects[] | select(.source == $source)' docs.json > /dev/null; then
              echo "::warning file=$file::No redirect found for deleted file: $file (expected redirect source: $redirect_source)"
              missing_redirects+=("$file")
            else
              echo "✓ Redirect found for: $file"
            fi
          done <<< "$deleted_files"
          
          if [ ${#missing_redirects[@]} -gt 0 ]; then
            echo ""
            echo "⚠️  The following deleted files are missing redirects in docs.json:"
            printf '  - %s\n' "${missing_redirects[@]}"
            echo ""
            echo "Consider adding redirects to prevent broken links."
          else
            echo ""
            echo "✓ All deleted .mdx files have redirects configured."
          fi
