---
title: URL Rewrite Action
sidebarTitle: URL Rewrite
description: Modify the incoming request URL using regular expressions before it reaches the upstream server, while keeping the URL seen by the client unchanged.
---

import ActionVariablesDescription from "/snippets/traffic-policy/common/action-variables-description.mdx";

import { ConfigField } from "/snippets/ConfigTable.jsx";
import { ConfigChildren } from "/snippets/ConfigChildren.jsx";

The **URL Rewrite** Traffic Policy action allows you to modify the incoming request URL using regular expressions before it reaches the upstream server, while keeping the URL seen by the client unchanged.

This action is particularly useful for routing users without exposing internal system details.

## Configuration Reference

This is the [Traffic Policy](/traffic-policy/) configuration
reference for this action.

### Supported Phases

`on_http_request`

### Type

`url-rewrite`

### Configuration Fields


    <ConfigField title="from" type="string" required={false} cel={true}>
        <p>A regular expression pattern used to match a part of the URL.</p>
        <p>Supports [CEL Interpolation](/traffic-policy/concepts/cel-interpolation).</p>
    </ConfigField>

    <ConfigField title="to" type="string" required={true} cel={true}>
        <p>A regular expression pattern used to replace the matched part of the URL.</p>
        <p>Supports [CEL Interpolation](/traffic-policy/concepts/cel-interpolation).</p>
    </ConfigField>

## Behavior

This action replaces all occurrences of the `from` regular expression in the request URL with the `to` replacement value.

### Matching

Matching is performed against the entire URL, including the scheme, userinfo, host, and port, not just the path.

To match requests that begin with `/products`, use [CEL Interpolation](/traffic-policy/concepts/cel-interpolation) and write `^${req.url.authority}/products`, or use an expression like `req.url.path.startsWith('/products')` in the phase rule's `expressions` field.

### Note about CEL Interpolation

All CEL Interpolation will occur **before** regular expressions
are evaluated.

## Examples

### Rewrite using Paths

The following [Traffic Policy](/traffic-policy/)
configuration demonstrates how to use the `url-rewrite` action to transparently
rewrite the request URL from `/products` to `/products.php`.

#### Example Traffic Policy Document

<CodeGroup>
```yaml policy.yml
on_http_request:
  - expressions:
      - req.url.path == '/products'
    actions:
      - type: url-rewrite
        config:
          from: /products
          to: /products.php
```

```json policy.json
{
  "on_http_request": [
    {
      "expressions": [
        "req.url.path == '/products'"
      ],
      "actions": [
        {
          "type": "url-rewrite",
          "config": {
            "from": "/products",
            "to": "/products.php"
          }
        }
      ]
    }
  ]
}
```
</CodeGroup>

This configuration will rewrite any request to `/products` to `/products.php`
without changing the URL seen by the client. This is useful for hiding away
the underlying implementation details of your service.

#### Example Request

```bash
$ curl -i https://example.ngrok.app/products
```

```http
HTTP/2 200 OK
```

##### Example Server Logs

```http
GET /product.php               200 OK
```

#### Conclusion

In this example, a request to `/products` is internally
routed to `/products.php`, and the response is served
from `products.php` while the client remains unaware
of the URL rewrite.

### Rewrite using Regular Expressions

The following [Traffic Policy](/traffic-policy/)
configuration demonstrates how to use the `url-rewrite` action to transparently
rewrite the request URL from `/products/*` to `/products.php`.

#### Example Traffic Policy Document

<CodeGroup>
```yaml policy.yml
on_http_request:
  - expressions:
      - req.url.path.startsWith('/products')
    actions:
      - type: url-rewrite
        config:
          from: /products/?([.*]+)?
          to: /products.php?query=$1
```

```json policy.json
{
  "on_http_request": [
    {
      "expressions": [
        "req.url.path.startsWith('/products')"
      ],
      "actions": [
        {
          "type": "url-rewrite",
          "config": {
            "from": "/products/?([.*]+)?",
            "to": "/products.php?query=$1"
          }
        }
      ]
    }
  ]
}
```
</CodeGroup>

This configuration will rewrite any request to `/products/*` to
`/products.php?query=$1` without changing the URL seen by the client. This is
useful for hiding away the underlying implementation details of your service.

#### Example Request

```bash
$ curl -i https://example.ngrok.app/products/123
```

```http
HTTP/2 200 OK
```

##### Example Server Logs

```http
GET /product.php?query=123          200 OK
```

#### Conclusion

In this example, a request to `/products` is internally routed to
`/products.php?query=123`, and the response is served from `products.php` while
the client remains unaware of the URL rewrite.

### Rewrite using CEL Interpolation

The following [Traffic Policy](/traffic-policy/)
configuration demonstrates how to use the `url-rewrite` action to transparently
rewrite the request URL from `/products/*` to `/products.php` using a global
policy rule (no expression) by leveraging [CEL Interpolation](/traffic-policy/concepts/cel-interpolation).

#### Example Traffic Policy Document

<CodeGroup>
```yaml policy.yml
on_http_request:
  - actions:
      - type: url-rewrite
        config:
          from: ${req.url.authority}/products/?([.*]+)?
          to: /products.php?query=$1
```

```json policy.json
{
  "on_http_request": [
    {
      "actions": [
        {
          "type": "url-rewrite",
          "config": {
            "from": "${req.url.authority}/products/?([.*]+)?",
            "to": "/products.php?query=$1"
          }
        }
      ]
    }
  ]
}
```
</CodeGroup>

This configuration will rewrite any request urls that start with `/products/*`
to `/products.php?query=$1` without changing the URL seen by the client. It does
this by leveraging [CEL Interpolation](/traffic-policy/concepts/cel-interpolation) to replace the
`from` value with the request URL authority. This is useful for hiding away the
underlying implementation details of your service.

#### Example Request

```bash
$ curl -i https://example.ngrok.app/products/123
```

```http
HTTP/2 200 OK
```

##### Example Server Logs

```http
GET /product.php?query=123          200 OK
```

#### Conclusion

In this example, a request to `/products` is internally routed to
`/products.php?query=123`, and the response is served from `products.php` while
the client remains unaware of the URL rewrite.

## Action Result Variables

<ActionVariablesDescription />

    <ConfigField title="actions.ngrok.url_rewrite.matches" type="array of strings">
        <p>List of elements that matched the URL before the rewrite action was applied. These can be specific parts of the URL, such as the domain, path, or query parameters, that were matched based on the action configuration.</p>
    </ConfigField>
    
    <ConfigField title="actions.ngrok.url_rewrite.url" type="string">
        <p>The final URL after the rewrite action has been applied. This is the new URL to which the original request is redirected after the specified modifications have been made.</p>
    </ConfigField>

    <ConfigField title="actions.ngrok.url_rewrite.error.code" type="string">
        <p>A machine-readable code describing an error that occurred during the action's execution.</p>
    </ConfigField>

    <ConfigField title="actions.ngrok.url_rewrite.error.message" type="string">
        <p>A human-readable message providing details about an error that occurred during the action's execution.</p>
    </ConfigField>
