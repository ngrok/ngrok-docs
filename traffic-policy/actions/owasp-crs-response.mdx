---
title: OWASP CRS Response Action
sidebarTitle: OWASP CRS Response
description: The OWASP CRS Response action enables OWASP Core Rule Set (CRS) to analyze outgoing HTTP responses from your endpoint and protect against common web attacks.
---

import ActionVariablesDescription from "/snippets/traffic-policy/common/action-variables-description.mdx";
import { YouTubeEmbed } from "/snippets/YouTubeEmbed.jsx";

import { ConfigField } from "/snippets/ConfigTable.jsx";
import { ConfigChildren } from "/snippets/ConfigChildren.jsx";

The **OWASP CRS Response** Traffic Policy action enables OWASP (Open Worldwide Application
Security Project) CRS (previously Core Rule Set), a set of generic attack detection
rules for use with ModSecurity or compatible web application firewalls. It aims to protect
web applications from a wide range of attacks, including the
[OWASP Top Ten](https://owasp.org/www-project-top-ten/), with a minimum of false alerts.
CRS provides protection against many common attack categories, including SQL Injection,
Cross Site Scripting, Local File Inclusion, etc.

The `owasp-crs-response` action only enables rule processing on _outgoing_ HTTP responses from your
endpoint. In addition to this action, we also recommend you enable the [OWASP CRS Request
action](/traffic-policy/actions/owasp-crs-request/) to analyze _incoming_ HTTP requests to your endpoint.

## Video walkthrough

The video below walks you through ngrok's OWASP CRS request and response actions in Traffic Policy, which let you add web application firewall protection directly to your ngrok endpoints without changing your existing infrastructure.

<YouTubeEmbed videoId="HHxj5VGFTEA" title="Block web attacks with ngrok's OWASP CRS Response" />

<ActionOverview />

### Configuration Reference

This is the [Traffic Policy](/traffic-policy/) configuration
reference for this action.

#### Supported Phases

`on_http_response`

#### Type

`owasp-crs-response`

#### Configuration Fields

    <ConfigField title="on_error" type="string" required={true}>
        <p>Behavior if there is an error. Must be one of either "continue" or "halt" (default "halt")</p>
        <p>More information can be found in the [Managing Fallback Behavior](#on-error) section.</p>
    </ConfigField>

    <ConfigField title="process_body" type="bool" required={false}>
        <p>If false, we do not process rules for the response body. Default is false.</p>
    </ConfigField>

    <ConfigField title="exclude_rule_ids" type="array of integers" required={false}>
        <p>List of OWASP CRS rule IDs to exclude from evaluation.</p>
        <p>The minimum value is <code>900000</code> and the maximum value is <code>999999</code>.</p>
    </ConfigField>


## Behavior

This action evaluates rules for response headers and body (when `process_body` is enabled), and each matching rule adds to the overall score of a response. If the score exceeds the set score threshold, the action will block the response.

The tallying process is called Anomaly Scoring, and is detailed on [the CRS website.](https://coreruleset.org/docs/2-how-crs-works/2-1-anomaly_scoring/)

### Default Behavior

The default behavior for this action is based on the following [Coraza](https://coraza.io/) directives and rules from v4.14.0 of the CRS:

- [coraza.conf-recommended](https://github.com/corazawaf/coraza/blob/main/coraza.conf-recommended)
- [crs-setup.conf.example](https://github.com/corazawaf/coraza-coreruleset/blob/main/rules/%40crs-setup.conf.example)
- [@owasp_crs/\*.conf](https://github.com/corazawaf/coraza-coreruleset/tree/main/rules/%40owasp_crs)

Included in these rules is an outbound anomaly score threshold of 4 and a [paranoia level](https://coreruleset.org/docs/2-how-crs-works/2-2-paranoia_levels/) of 1.

### Managing Fallback Behavior (`on_error`) 

If `on_error` is set to `halt` (default) and the action encounters an error when forwarding traffic, the Traffic Policy chain will halt and no further actions will be executed. For example, if you have a `log` action after the `owasp-crs-response` action, the `log` action will not be run and the error will be returned.

However, if `on_error` is set to `continue`, actions that appear after the `owasp-crs-response` action will still be executed even if the `owasp-crs-response` action encounters an error.

### Body Processing

When `process_body` is enabled, ngrok evaluates rules against the first 4kb of the body. If the body is larger than 4kb, we ignore the portion after the first 4kb.

### Rule Exclusion

When `exclude_rule_ids` is configured, ngrok skips evaluation of the specified rule IDs. This allows you to disable specific OWASP CRS rules that may be causing false positives in your environment.

### Outbound Anomaly Score Threshold Exceeded

If the anomaly score accumulated from matching rules exceeds the threshold, ngrok blocks the request with a `HTTP 403` response. The response from your upstream does not make it to the client.

### Failure to process the body successfully

If ngrok is unable to read the response body successfully, ngrok blocks the response with a `HTTP 500` response. The response from your upstream does not make it to the client.

## Examples

### Running in block mode

The following configuration demonstrates how to run the `owasp-crs-response` action in block mode.

#### Example Traffic Policy Document

<CodeGroup>
```yaml policy.yml {5}
on_http_response:
  - actions:
      - type: owasp-crs-response
        config:
          on_error: halt
```

```json policy.json {8}
{
  "on_http_response": [
    {
      "actions": [
        {
          "type": "owasp-crs-response",
          "config": {
            "on_error": "halt"
          }
        }
      ]
    }
  ]
}
```
</CodeGroup>

### Running in test mode

The following configuration demonstrates how to run the `owasp-crs-response` action in test mode where rules are evaluated but blocks are not enforced.

#### Example Traffic Policy Document

<CodeGroup>
```yaml policy.yml {5}
on_http_response:
  - actions:
      - type: owasp-crs-response
        config:
          on_error: continue
      - type: log
        config:
          metadata:
            message: OWASP CRS response action would be ${actions.ngrok.owasp_crs_response.decision} for ${req.url}
            error_code: ${actions.ngrok.owasp_crs_response.error.code}
            error_message: ${actions.ngrok.owasp_crs_response.error.message}
            matched_rules_first_id: ${actions.ngrok.owasp_crs_response.matched_rules[0].id}
            matched_rules_first_message: ${actions.ngrok.owasp_crs_response.matched_rules[0].message}
            matched_rules_first_data: ${actions.ngrok.owasp_crs_response.matched_rules[0].data}
```

```json policy.json {8}
{
  "on_http_response": [
    {
      "actions": [
        {
          "type": "owasp-crs-response",
          "config": {
            "on_error": "continue"
          }
        },
        {
          "type": "log",
          "config": {
            "metadata": {
              "message": "OWASP CRS response action would be ${actions.ngrok.owasp_crs_response.decision} for ${req.url}",
              "error_code": "${actions.ngrok.owasp_crs_response.error.code}",
              "error_message": "${actions.ngrok.owasp_crs_response.error.message}",
              "matched_rules_first_id": "${actions.ngrok.owasp_crs_response.matched_rules[0].id}",
              "matched_rules_first_message": "${actions.ngrok.owasp_crs_response.matched_rules[0].message}",
              "matched_rules_first_data": "${actions.ngrok.owasp_crs_response.matched_rules[0].data}"
            }
          }
        }
      ]
    }
  ]
}
```
</CodeGroup>

### Example response from your upstream that ngrok would block

A `text/plain` response like the following will result in ngrok blocking the response due to potential security leaks i.e. SQL Injection vulnerabilities.

```
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'SELECT * FROM users WHERE id = 'abc'' at line 1
```

## Action Result Variables

<ActionVariablesDescription />

	<ConfigField title="actions.ngrok.owasp_crs_response.decision" type="string">
		<p>The action taken for this response.</p>
        <ConfigEnum label="Possible values">
            <ConfigEnumOption>`allow` - If the response was permitted.</ConfigEnumOption>
            <ConfigEnumOption>`deny` - If the response was denied.</ConfigEnumOption>
        </ConfigEnum>
	</ConfigField>
	<ConfigField title="actions.ngrok.owasp_crs_response.anomaly_score" type="int">
		<p>
			The total anomaly score for the response. If it equals to or exceeds the set threshold, it will
            block the response.
		</p>
	</ConfigField>
    	<ConfigField title="actions.ngrok.owasp_crs_response.anomaly_score_threshold" type="int">
		<p>
			The total anomaly score threshold for the response. By default, it is set to 4.
		</p>
	</ConfigField>
	<ConfigField
		title="actions.ngrok.owasp_crs_response.matched_rules"
		type="array of objects"
	>
		<p>The list of all rules matched by this response that have a non-zero score.</p>
		<ConfigChildren>
			<ConfigField title="matched_rules[i].id" type="int">
				<p>
					The ID of the rule.
				</p>
			</ConfigField>
			<ConfigField title="matched_rules[i].message" type="string">
				<p>
					The text message describing the rule.
				</p>
			</ConfigField>
			<ConfigField title="matched_rules[i].severity" type="string">
				<p>
					The [severity](https://coraza.io/docs/seclang/actions/#severity) of the matched rule. 
				</p>
			</ConfigField>
			<ConfigField title="matched_rules[i].data" type="string">
				<p>
					Any extra data about the rule and how it matched the response.
				</p>
			</ConfigField>
		</ConfigChildren>
	</ConfigField>
	<ConfigField title="actions.ngrok.owasp_crs_response.error.code" type="string">
		<p>
			A machine-readable code describing an error that occurred during the
			action's execution.
		</p>
	</ConfigField>
	<ConfigField title="actions.ngrok.owasp_crs_response.error.message" type="string">
		<p>
			A human-readable message providing details about an error that occurred
			during the action's execution.
		</p>
	</ConfigField>
